{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                模型训练
            </div>
            <div class="card-body">
                <h5 class="card-title">训练教学行为识别模型</h5>
                <p class="card-text">基于已标注的数据训练模型，系统将自动提取特征并训练分类器。</p>
                
                <!-- 数据统计 -->
                <div class="mb-4">
                    <div class="alert alert-info" role="alert">
                        <h6>已标注数据统计</h6>
                        <p>当前系统中有 <strong>{{ annotated_count }}</strong> 个已标注文件，可用于模型训练。</p>
                        {% if annotated_count == 0 %}
                            <p class="text-danger">请先上传并标注数据，然后再进行模型训练。</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 训练按钮和进度显示 -->
                <form id="trainForm" method="post">
                    <button type="submit" class="btn btn-primary" {% if annotated_count == 0 %}disabled{% endif %} id="trainBtn">
                        开始训练模型
                    </button>
                </form>
                
                <!-- 训练进度显示 -->
                <div id="progressContainer" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            训练进度
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="progressBar" class="form-label">进度</label>
                                <div class="progress">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="progressText" class="text-muted"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 训练说明 -->
                <div class="mt-4">
                    <h6>训练说明</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">系统将使用SVM算法训练分类模型</li>
                        <li class="list-group-item">训练过程中会自动分割训练集和测试集</li>
                        <li class="list-group-item">训练完成后会显示模型准确率</li>
                        <li class="list-group-item">训练时间取决于数据量大小，可能需要几分钟</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 监听表单提交事件
document.getElementById('trainForm').addEventListener('submit', function(e) {
    e.preventDefault(); // 阻止默认提交行为
    
    // 显示进度条
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('trainBtn').disabled = true;
    document.getElementById('trainBtn').textContent = '训练中...';
    
    // 初始化进度
    updateProgress(0, '开始准备训练数据...');
    
    // 发送训练请求
    fetch('/train', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 训练成功，跳转到模型列表页面
            updateProgress(100, '训练完成! 正在跳转到模型列表...');
            setTimeout(() => {
                window.location.href = '/models';
            }, 1000);
        } else {
            // 训练失败
            updateProgress(0, '训练失败: ' + data.message);
            document.getElementById('trainBtn').disabled = false;
            document.getElementById('trainBtn').textContent = '开始训练模型';
        }
    })
    .catch(error => {
        console.error('训练请求失败:', error);
        updateProgress(0, '训练请求失败: ' + error.message);
        document.getElementById('trainBtn').disabled = false;
        document.getElementById('trainBtn').textContent = '开始训练模型';
    });
});

// 更新进度显示
function updateProgress(progress, status) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = status;
}
</script>
{% endblock %}