{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                数据标注
            </div>
            <div class="card-body">
                <h5 class="card-title">标注文件：{{ data_file.filename }}</h5>
                
                {% if data_file.file_type == 'video' %}
                <!-- 视频帧提取提示 -->
                <div class="mb-4">
                    {% if frames and frames|length > 0 %}
                    <!-- 视频帧列表 -->
                    <div class="mb-4">
                        <h6>视频帧列表</h6>
                        <div class="row">
                            {% for frame in frames %}
                            <div class="col-md-3 mb-3">
                                <div class="card {% if frame.is_annotated %}border-success{% else %}border-primary{% endif %}">
                                    <div class="card-body p-2">
                                        <img src="{{ url_for('static', filename=frame.path) }}" class="img-fluid" alt="Frame {{ frame.index }}">
                                        <p class="text-center small mt-1">帧 {{ frame.index }}</p>
                                        {% if frame.is_annotated %}
                                        <span class="badge bg-success">已标注</span>
                                        {% else %}
                                        <button class="btn btn-sm btn-primary mt-1" data-frame-index="{{ frame.index }}" onclick="selectFrame({{ frame.index }})">选择标注</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- 分页导航 -->
                    {% if total_pages > 1 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination pagination-sm justify-content-center">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=page-1) }}" tabindex="-1">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="sr-only">上一页</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="sr-only">上一页</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            <!-- 显示当前页附近的页码 -->
                            {% set start_page = 1 if (page - 2) < 1 else (page - 2) %}
                            {% set end_page = total_pages if (start_page + 4) > total_pages else (start_page + 4) %}
                            
                            {% if start_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=1) }}">1</a>
                            </li>
                            {% if start_page > 2 %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">...</a>
                            </li>
                            {% endif %}
                            {% endif %}
                            
                            {% for p in range(start_page, end_page + 1) %}
                            <li class="page-item {% if p == page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=p) }}">{{ p }}</a>
                            </li>
                            {% endfor %}
                            
                            {% if end_page < total_pages %}
                            {% if end_page < total_pages - 1 %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">...</a>
                            </li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=total_pages) }}">{{ total_pages }}</a>
                            </li>
                            {% endif %}
                            
                            {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=page+1) }}">
                                    <span aria-hidden="true">&raquo;</span>
                                    <span class="sr-only">下一页</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">
                                    <span aria-hidden="true">&raquo;</span>
                                    <span class="sr-only">下一页</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    </div>
                    
                    <!-- 当前选中帧预览 -->
                    <div id="framePreview" class="mb-4" style="display: none;">
                        <h6>当前选中帧</h6>
                        <div style="max-width: 100%; overflow: auto;">
                            <img id="previewImage" src="" class="img-fluid" alt="Selected frame" style="max-width: none; width: 1000px;">
                        </div>
                        <p id="frameInfo" class="text-muted mt-2"></p>
                    </div>
                    {% else %}
                    <!-- 视频帧提取中或失败 -->
                    <div class="alert alert-info" role="alert">
                        <h6>视频帧提取</h6>
                        <p>系统正在提取视频帧，请稍候...</p>
                        <p class="text-muted">如果提取时间过长，可能是视频文件较大或系统资源不足，请耐心等待。</p>
                        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="location.reload()">刷新查看</button>
                    </div>
                    {% endif %}
                </div>
                {% elif data_file.file_type == 'image' %}
                <!-- 图片预览 -->
                <div class="mb-4">
                    <img src="{{ url_for('static', filename='uploads/' + data_file.filename) }}" class="img-fluid" alt="Uploaded image">
                </div>
                {% endif %}
                
                <!-- 标注表单 -->
                <form method="post">
                    <input type="hidden" id="frame_index" name="frame_index" value="">
                    
                    <div class="mb-3">
                        <label for="behavior" class="form-label">教学行为类型</label>
                        <select class="form-select" id="behavior" name="behavior" required>
                            <option value="">请选择行为类型</option>
                            {% for key, value in behaviors_list %}
                                <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    {% if data_file.file_type == 'video' %}
                    <div class="mb-3">
                        <label for="timestamp" class="form-label">帧索引</label>
                        <input type="number" class="form-control" id="timestamp" name="timestamp" step="1" placeholder="例如：10" required>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="coordinates" class="form-label">目标坐标（可选）</label>
                        <input type="text" class="form-control" id="coordinates" name="coordinates" placeholder="例如：x1,y1,x2,y2">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">保存标注</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 已标注信息 -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">已标注信息</h5>
            </div>
            <div class="card-body">
                {% if annotations.items %}
                    <div class="row g-3 mb-3">
                        {% for annotation in annotations.items %}
                            <div class="col-12">
                                <div class="card border-0 shadow-sm hover-lift">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-start">
                                            <!-- 缩略图 -->
                                            <div class="me-3">
                                                <div class="position-relative">
                                                    <img 
                                                        src="{{ url_for('static', filename=annotation.thumbnail_path) }}" 
                                                        class="img-thumbnail rounded" 
                                                        alt="Annotated frame" 
                                                        style="width: 100px; height: 80px; object-fit: cover; cursor: pointer; transition: all 0.2s ease;" 
                                                        onclick="showAnnotationDetail('{{ annotation.thumbnail_path }}', '{{ annotation.coordinates }}', {{ annotation.timestamp if annotation.timestamp else 'null' }}, '{{ behaviors[annotation.behavior] if annotation.behavior in behaviors else annotation.behavior }}')"
                                                    >
                                                    <div class="position-absolute top-0 end-0 bg-primary text-white rounded-bottom-start p-1 text-xs">
                                                        {{ annotation.behavior }}
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 标注信息 -->
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <strong class="text-primary">行为类型：</strong>
                                                </div>
                                                <p class="mb-1">{{ behaviors[annotation.behavior] if annotation.behavior in behaviors else annotation.behavior }}</p>
                                                {% if annotation.timestamp %}
                                                    <div class="small text-muted mb-1">帧索引：{{ annotation.timestamp }}</div>
                                                {% endif %}
                                                {% if annotation.coordinates %}
                                                    <div class="small text-muted mb-1">坐标：{{ annotation.coordinates }}</div>
                                                {% endif %}
                                                <div class="text-xs text-muted">标注时间：{{ annotation.annotation_time.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 标注分页导航 -->
                    {% if annotations.pages > 1 %}
                    <nav aria-label="Annotation pagination">
                        <ul class="pagination pagination-sm justify-content-center pagination-rounded">
                            {% if annotations.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=annotations.prev_num) }}" tabindex="-1">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="sr-only">上一页</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="sr-only">上一页</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for p in annotations.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                {% if p %}
                                <li class="page-item {% if p == annotations.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=p) }}">{{ p }}</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if annotations.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('annotate', file_id=data_file.id, page=annotations.next_num) }}">
                                    <span aria-hidden="true">&raquo;</span>
                                    <span class="sr-only">下一页</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">
                                    <span aria-hidden="true">&raquo;</span>
                                    <span class="sr-only">下一页</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clipboard-check text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2">暂无标注信息</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        {% if data_file.file_type == 'video' %}
        <div class="card mt-3">
            <div class="card-header">
                视频信息
            </div>
            <div class="card-body">
                <p><strong>总帧数：</strong>{{ total_frames }}</p>
                <p><strong>已标注帧数：</strong>{{ annotations.total }}</p>
                <p><strong>标注进度：</strong>{{ "%.1f"|format(annotations.total / total_frames * 100 if total_frames > 0 else 0) }}%</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 标注详情模态框 -->
    <div class="modal fade" id="annotationDetailModal" tabindex="-1" aria-labelledby="annotationDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="annotationDetailModalLabel">标注详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <img id="detailImage" src="" class="img-fluid" alt="Annotation detail">
                                <canvas id="detailCanvas" class="position-absolute top-0 start-0 w-100 h-100"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>标注信息</h6>
                            <p id="detailBehavior"></p>
                            <p id="detailTimestamp"></p>
                            <p id="detailCoordinates"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let startX, startY, endX, endY;
let isDrawing = false;
let canvas, ctx;
let detailCanvas, detailCtx;

function selectFrame(frameIndex) {
    // 显示预览
    document.getElementById('framePreview').style.display = 'block';
    
    // 设置帧信息
    document.getElementById('frameInfo').textContent = '当前选中帧：' + frameIndex;
    document.getElementById('timestamp').value = frameIndex;
    document.getElementById('frame_index').value = frameIndex;
    
    // 设置预览图片
    const framePath = 'frames/{{ data_file.id }}/frame_' + frameIndex.toString().padStart(4, '0') + '.jpg';
    const previewImage = document.getElementById('previewImage');
    previewImage.src = '{{ url_for('static', filename='') }}' + framePath;
    
    // 图片加载完成后初始化画布
    previewImage.onload = function() {
        initCanvas();
    };
}

function initCanvas() {
    const previewImage = document.getElementById('previewImage');
    const container = document.getElementById('framePreview');
    
    // 创建画布
    canvas = document.createElement('canvas');
    canvas.id = 'annotationCanvas';
    canvas.width = previewImage.width;
    canvas.height = previewImage.height;
    canvas.style.position = 'absolute';
    canvas.style.top = previewImage.offsetTop + 'px';
    canvas.style.left = previewImage.offsetLeft + 'px';
    canvas.style.cursor = 'crosshair';
    canvas.style.zIndex = '10';
    
    // 添加画布到容器
    container.appendChild(canvas);
    
    // 获取上下文
    ctx = canvas.getContext('2d');
    
    // 获取原始图片尺寸
    canvas.originalWidth = previewImage.naturalWidth;
    canvas.originalHeight = previewImage.naturalHeight;
    
    // 绑定鼠标事件
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // 添加清除按钮
    const clearBtn = document.createElement('button');
    clearBtn.className = 'btn btn-sm btn-danger mt-2';
    clearBtn.textContent = '清除标注框';
    clearBtn.onclick = clearCanvas;
    container.appendChild(clearBtn);
}

function startDrawing(e) {
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    isDrawing = true;
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    endX = e.clientX - rect.left;
    endY = e.clientY - rect.top;
    
    // 清除画布并重新绘制
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.rect(startX, startY, endX - startX, endY - startY);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.stroke();
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        
        // 计算坐标
        const x1 = Math.min(startX, endX);
        const y1 = Math.min(startY, endY);
        const x2 = Math.max(startX, endX);
        const y2 = Math.max(startY, endY);
        
        // 将坐标转换为原始图片的坐标
        const scaleX = canvas.originalWidth / canvas.width;
        const scaleY = canvas.originalHeight / canvas.height;
        
        const originalX1 = Math.round(x1 * scaleX);
        const originalY1 = Math.round(y1 * scaleY);
        const originalX2 = Math.round(x2 * scaleX);
        const originalY2 = Math.round(y2 * scaleY);
        
        // 填充坐标输入框
        document.getElementById('coordinates').value = `${originalX1},${originalY1},${originalX2},${originalY2}`;
        
        // 显示坐标信息
        document.getElementById('frameInfo').textContent = `当前选中帧：${document.getElementById('timestamp').value} | 坐标：${originalX1},${originalY1},${originalX2},${originalY2}`;
    }
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('coordinates').value = '';
    document.getElementById('frameInfo').textContent = '当前选中帧：' + document.getElementById('timestamp').value;
}

// 显示标注详情
function showAnnotationDetail(thumbnailPath, coordinates, timestamp, behavior) {
    // 设置模态框中的图片
    const detailImage = document.getElementById('detailImage');
    const detailCanvas = document.getElementById('detailCanvas');
    
    // 加载图片
    detailImage.src = '{{ url_for('static', filename='') }}' + thumbnailPath;
    
    // 初始化画布尺寸
    detailImage.onload = function() {
        detailCanvas.width = detailImage.width;
        detailCanvas.height = detailImage.height;
        detailCanvas.style.width = detailImage.offsetWidth + 'px';
        detailCanvas.style.height = detailImage.offsetHeight + 'px';
        
        // 清除画布
        const detailCtx = detailCanvas.getContext('2d');
        detailCtx.clearRect(0, 0, detailCanvas.width, detailCanvas.height);
        
        // 如果有坐标，绘制标注框
        if (coordinates) {
            const coords = coordinates.split(',').map(Number);
            if (coords.length === 4) {
                const [x1, y1, x2, y2] = coords;
                
                // 绘制红色标注框
                detailCtx.beginPath();
                detailCtx.rect(x1, y1, x2 - x1, y2 - y1);
                detailCtx.strokeStyle = 'red';
                detailCtx.lineWidth = 2;
                detailCtx.stroke();
            }
        }
    };
    
    // 设置标注信息
    document.getElementById('detailBehavior').innerHTML = `<strong>行为类型：</strong>${behavior}`;
    document.getElementById('detailTimestamp').innerHTML = timestamp ? `<strong>帧索引：</strong>${timestamp}` : '';
    document.getElementById('detailCoordinates').innerHTML = coordinates ? `<strong>坐标：</strong>${coordinates}` : '';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('annotationDetailModal'));
    modal.show();
}
</script>
{% endblock %}